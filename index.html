<!DOCTYPE html>
<head>
<meta charset="utf-8">
<title>CVE Map Project</title>
<h1 align="center"> CVE Map Project</h1>
<!-- Alejandro Suarezâ€™s Block 4333a12d2531d6c1f6f22b74f2c57102, Released under the GNU General Public License, version 3.  -->
</head>
<meta charset="utf-8">
<style>

	.link {
	  stroke: #c1c1c1;
    stroke-width: 2px;
    pointer-events: all;
	}

  .node circle {
	  pointer-events: all;
	  stroke: #777;
	  stroke-width: 1px;
	}

	div.tooltip {
    position: absolute;
		font-size: 9px;
    background-color:white;
    max-width; 200px;
    height: auto;
    padding: 1px;
    border-style: solid;
    border-radius: 4px;
    border-width: 1px;
    box-shadow: 3px 3px 10px rgba(0, 0, 0, .5);
    pointer-events: all;
  }

text {
  font-family: sans-serif;
  font-size: 8px;
	color:white;
}

header {
		font-family: sans-serif;
}
footer {
		font-family: sans-serif;
}

footer {
			font-family: sans-serif;
}

</style>
<head>
<body>
</body>
<svg width="1280" height="800"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.24.0/d3-legend.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script>

var color = d3.scaleOrdinal() // D3 Version 4
	.domain(["Accelerator/Incubator", "Innovation Competition", "International Government", "Local Government", "National Government", "NGO", "Private Sector", "Start Up", "Think Tank", "Venture Funder", "Unversity", "Other"])
	.range(["#f6b93b", "#e55039" , "#4a69bd", "#60a3bc", "#78e08f", "#fa983a", "#b71540","#1e3799","#079992","#b8e994"]);

var tooltip = d3.select("body")
	.append("div")
	.attr("class", "tooltip")
	.style("opacity", 0);

d3.json("05_12.json", function(error, graph) {
  if (error) throw error;
 	const svg = d3.select('svg'),
        width = +svg.attr('width'),
  			height = +svg.attr('height');


//  const width = 960;
//   const height = 700;

  const simulation = d3.forceSimulation()
    .nodes(graph.nodes)
    .force('link', d3.forceLink().id(d => d.id))
    .force('charge', d3.forceManyBody())
    .force('center', d3.forceCenter(width / 2, height / 2))
    .on('tick', ticked);

  simulation.force('link')
    .links(graph.links);

  const R = 6;

  var link = svg.selectAll('line')
    .data(graph.links)
    .enter().append('line');

  link
    .attr('class', 'link')
  	.on('mouseover.tooltip', function(d) {
      	tooltip.transition()
        	.duration(300)
        	.style("opacity", .8);
      	tooltip.html("Relationship:"  + d.relationship)
        	.style("left", (d3.event.pageX) + "px")
        	.style("top", (d3.event.pageY + 10) + "px");
    	})
    	.on("mouseout.tooltip", function() {
	      tooltip.transition()
	        .duration(100)
	        .style("opacity", 0);
	    })
  		.on('mouseout.fade', fade(1))
	    .on("mousemove", function() {
	      tooltip.style("left", (d3.event.pageX) + "px")
	        .style("top", (d3.event.pageY + 10) + "px");
	    });
;
  var node = svg.selectAll('.node')
    .data(graph.nodes)
    .enter().append('g')
    .attr('class', 'node')
    .call(d3.drag()
    	.on("start", dragstarted)
      .on("drag", dragged)
      .on("end", dragended));;

  node.append('circle')
    .attr('r', R)
  	.attr("fill", function(d) { return color(d.group);})
    .on('mouseover.tooltip', function(d) {
      	tooltip.transition()
        	.duration(300)
        	.style("opacity", .8);
      	tooltip.html("Name: " + d.name + "</br>" +
					"Organization Type: " + d.type + "</br>" +
					"Description: " + d.description + "</br>" +
					"Key People:" + d.people + "</br>" +
        '<a href= "'+ d.website +'" target="_blank">' + "Website" + "</a>" +
				"&nbsp" +'<a href= "'+ d.facebook+'" target="_blank">' + "Facebook" +
				"</a>" + "&nbsp" +'<a href= "'+ d.twitter+'" target="_blank">' + "Twitter")
        	.style("left", (d3.event.pageX) + "px")
        	.style("top", (d3.event.pageY + 10) + "px");
    	})
  	.on('mouseover.fade', fade(0.1))
    .on("mouseout.tooltip", function() {
        tooltip.transition()
	        .duration(5000)
	        .style("opacity", 0);
	    })
  	.on('mouseout.fade', fade(1))
	    .on("mousemove", function() {
	      tooltip.style("left", (d3.event.pageX) + "px")
	        .style("top", (d3.event.pageY + 10) + "px");
	    })
  	.on('dblclick',releasenode)


  node.append('text')
    .attr('x', 0)
    .attr('dy', '.35em')
    .text(d => d.name);

  function ticked() {
    link
      .attr('x1', d => d.source.x)
      .attr('y1', d => d.source.y)
      .attr('x2', d => d.target.x)
      .attr('y2', d => d.target.y);

    node
      .attr('transform', d => `translate(${d.x},${d.y})`);
  }

function dragstarted(d) {
  if (!d3.event.active) simulation.alphaTarget(0.3).restart();
  d.fx = d.x;
  d.fy = d.y;
}

function dragged(d) {
  d.fx = d3.event.x;
  d.fy = d3.event.y;
}

function dragended(d) {
  if (!d3.event.active) simulation.alphaTarget(0);
  //d.fx = null;
  //d.fy = null;
}
function releasenode(d) {
    d.fx = null;
    d.fy = null;
}

  const linkedByIndex = {};
  graph.links.forEach(d => {
    linkedByIndex[`${d.source.index},${d.target.index}`] = 1;
  });

  function isConnected(a, b) {
    return linkedByIndex[`${a.index},${b.index}`] || linkedByIndex[`${b.index},${a.index}`] || a.index === b.index;
  }

  function fade(opacity) {
    return d => {
      node.style('stroke-opacity', function (o) {
        const thisOpacity = isConnected(d, o) ? 1 : opacity;
        this.setAttribute('fill-opacity', thisOpacity);
        return thisOpacity;
      });

      link.style('stroke-opacity', o => (o.source === d || o.target === d ? 1 : opacity));

    };
  }
  var sequentialScale = d3.scaleOrdinal()
  .domain(["Accelerator/Incubator", "Innovation Competition", "International Government", "Local Government", "National Government", "NGO", "Private Sector", "Start Up", "Think Tank", "Venture Funder", "Unversity", "Other"])
	.range(["#f6b93b", "#e55039" , "#4a69bd", "#60a3bc", "#78e08f", "#fa983a", "#b71540","#1e3799","#079992","#b8e994"]);


svg.append("g")
  .attr("class", "legendSequential")
  .attr("transform", "translate("+(width-140)+","+(height-300)+")");

var legendSequential = d3.legendColor()
    .shapeWidth(30)
    .cells(11)
    .orient("vertical")
		.title("Organization Type by Color:")
		.titleWidth(100)
    .scale(sequentialScale)

svg.select(".legendSequential")
  .call(legendSequential);
})
</script>
<footer>
	<p align ="center"> Contact CVEMapProject@gmail.com </p>
</footer>
</html>